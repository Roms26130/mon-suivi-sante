<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health Tracker Pro v3.3</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .drop-anim { transition: all 0.2s ease; }
        .drop-anim:active { transform: scale(0.9); }
        /* Animation d'apparition douce */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-card { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Utilitaire Stockage Sécurisé ---
        const safeStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } 
                catch (e) { console.warn("Stockage inaccessible", e); return null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } 
                catch (e) { console.warn("Écriture impossible", e); }
            },
            removeItem: (key) => {
                try { localStorage.removeItem(key); }
                catch (e) { console.warn("Suppression impossible", e); }
            }
        };

        // --- Icônes ---
        const Icons = {
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ClipboardCopy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>,
            Sun: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>,
            Moon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Coffee: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="1" y2="4"/><line x1="10" x2="10" y1="1" y2="4"/><line x1="14" x2="14" y1="1" y2="4"/></svg>,
            CheckCircle2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            AlertCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            PlusCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>,
            BarChart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>,
            Lock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            User: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Dumbbell: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7.9-7.9a2.121 2.121 0 0 1 3 3L6 12.9a2.121 2.121 0 0 1-3-3Z"/><path d="m12.9 6 7.9 7.9a2.121 2.121 0 0 1-3 3L10 9a2.121 2.121 0 0 1 2.9-3Z"/></svg>,
            Droplets: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></svg>,
            Bed: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></svg>,
            LogOut: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        // --- Données par défaut ---
        const DEFAULT_SUPPLEMENTS = [
            { id: 't4', name: 'Lévothyrox', dosage: '100 µg', time: 'matin' },
            { id: 'glu', name: 'L-Glutamine', dosage: '5g', time: 'matin' },
            { id: 'multi', name: 'Multivitamines', dosage: '1 gélule', time: 'midi' },
            { id: 'o3', name: 'Oméga-3', dosage: '1000 mg', time: 'midi' },
            { id: 'mg', name: 'Magnésium', dosage: '300 mg', time: 'soir' },
            { id: 'ash', name: 'Ashwagandha', dosage: 'KSM-66', time: 'soir' },
        ];

        const DEFAULT_METRICS = [
            { id: 'energie', label: 'Énergie' },
            { id: 'moral', label: 'Moral' },
            { id: 'digestion', label: 'Digestion' },
            { id: 'stress', label: 'Stress' }
        ];
        
        const ACTIVITY_TYPES = ['Marche', 'Course', 'Muscu', 'Vélo', 'Yoga', 'Natation', 'Autre'];
        const DAYS = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];

        const INITIAL_DAY_DATA = {
            supplements: {}, 
            repasOk: { matin: false, midi: false, soir: false },
            metrics: {}, 
            hydration: 0, 
            sleep: { hours: '', quality: '' }, 
            activities: [], 
            notes: ''
        };

        const getWeekDates = (offsetWeeks = 0) => {
            const today = new Date();
            const first = today.getDate() - today.getDay() + 1 + (offsetWeeks * 7);
            const start = new Date(today.setDate(first));
            const end = new Date(today.setDate(first + 6));
            return {
                startStr: start.toLocaleDateString('fr-FR'),
                endStr: end.toLocaleDateString('fr-FR'),
                id: start.toISOString().split('T')[0] 
            };
        };

        // --- Composants ---

        const AuthScreen = ({ onLogin }) => {
            const [mode, setMode] = useState('login'); 
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                if (!safeStorage.getItem('sante_auth_config')) setMode('setup');
            }, []);

            const handleAuth = (e) => {
                e.preventDefault();
                setError('');
                if (mode === 'setup') {
                    if (username.length < 3 || password.length < 4) {
                        setError("Pseudo > 3 car. & MDP > 4 car.");
                        return;
                    }
                    safeStorage.setItem('sante_auth_config', JSON.stringify({ username, password }));
                    onLogin(username);
                } else {
                    const stored = JSON.parse(safeStorage.getItem('sante_auth_config'));
                    if (stored && stored.username === username && stored.password === password) {
                        onLogin(username);
                    } else {
                        setError("Erreur identifiants");
                    }
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <Card className="w-full max-w-sm p-6">
                        <div className="text-center mb-6">
                            <div className="bg-indigo-600 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3 text-white shadow-lg shadow-indigo-500/30">
                                <Icons.Lock size={24} />
                            </div>
                            <h1 className="text-xl font-bold text-slate-800">{mode === 'setup' ? 'Créer Compte' : 'Connexion'}</h1>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="block w-full rounded-lg border-slate-300 bg-slate-50 focus:border-indigo-500 focus:ring-indigo-500 border p-3 text-sm" placeholder="Nom d'utilisateur" />
                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="block w-full rounded-lg border-slate-300 bg-slate-50 focus:border-indigo-500 focus:ring-indigo-500 border p-3 text-sm" placeholder="Mot de passe" />
                            {error && <div className="text-red-500 text-xs text-center font-medium">{error}</div>}
                            <button type="submit" className="w-full py-3 px-4 rounded-lg text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-md transition-all active:scale-95">
                                {mode === 'setup' ? 'Commencer' : 'Accéder au Journal'}
                            </button>
                        </form>
                    </Card>
                </div>
            );
        };

        const DayCard = ({ day, data, configSupplements, configMetrics, onUpdate, onDeleteActivity }) => {
            const suppsDone = configSupplements.filter(s => data.supplements?.[s.id]).length;
            const suppsTotal = configSupplements.length;

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 animate-card flex flex-col h-full">
                    {/* Header Carte */}
                    <div className="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-xl">
                        <h3 className="font-bold text-lg text-slate-800">{day}</h3>
                        <div className="flex gap-1">
                            {suppsDone === suppsTotal && suppsTotal > 0 && <span className="w-2 h-2 rounded-full bg-emerald-500" title="Traitements complets"></span>}
                            {data.activities?.length > 0 && <span className="w-2 h-2 rounded-full bg-orange-500" title="Sport fait"></span>}
                            {parseInt(data.hydration) >= 8 && <span className="w-2 h-2 rounded-full bg-blue-500" title="Hydratation OK"></span>}
                        </div>
                    </div>

                    <div className="p-3 space-y-4 flex-1">
                        {/* 1. Hygiène */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-blue-50/50 p-2 rounded-lg border border-blue-100">
                                <div className="text-[10px] font-bold text-blue-600 mb-1 flex items-center gap-1"><Icons.Droplets size={10}/> EAU ({data.hydration})</div>
                                <div className="flex flex-wrap gap-1">
                                    {[1,2,3,4,5,6,7,8].map(i => (
                                        <button key={i} onClick={() => onUpdate('hydration', i === data.hydration ? i-1 : i)} className={`w-4 h-6 rounded-full border border-blue-200 transition-colors ${i <= data.hydration ? 'bg-blue-500 border-blue-600' : 'bg-white hover:bg-blue-50'}`}></button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-indigo-50/50 p-2 rounded-lg border border-indigo-100">
                                <div className="text-[10px] font-bold text-indigo-600 mb-1 flex items-center gap-1"><Icons.Bed size={10}/> SOMMEIL</div>
                                <div className="flex gap-1">
                                    <input type="number" placeholder="H" value={data.sleep?.hours} onChange={(e) => onUpdate('sleep', e.target.value, 'hours')} className="w-full text-xs p-1 border rounded text-center bg-white focus:ring-1 focus:ring-indigo-500 outline-none"/>
                                    <select value={data.sleep?.quality} onChange={(e) => onUpdate('sleep', e.target.value, 'quality')} className="w-full text-xs p-1 border rounded bg-white focus:ring-1 focus:ring-indigo-500 outline-none">
                                        <option value="">-</option><option value="1">1</option><option value="3">3</option><option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        {/* 2. Sport */}
                        <div className="bg-orange-50/30 p-2 rounded-lg border border-orange-100">
                            <div className="text-[10px] font-bold text-orange-600 mb-1 flex items-center gap-1"><Icons.Dumbbell size={10}/> SPORT</div>
                            <div className="space-y-1 mb-2">
                                {data.activities?.map(act => (
                                    <div key={act.id} className="bg-white p-1.5 rounded border border-orange-100 text-[10px] flex justify-between items-center">
                                        <span className="font-semibold truncate">{act.type} {act.duration}m</span>
                                        <button onClick={() => onDeleteActivity(act.id)} className="text-red-400 hover:text-red-600"><Icons.Trash2 size={12}/></button>
                                    </div>
                                ))}
                            </div>
                            <form onSubmit={(e) => { e.preventDefault(); const t = e.target; if(t.ty.value && t.du.value) { onUpdate('addActivity', {type: t.ty.value, duration: t.du.value, calories: t.ca.value, intensity: 'Moy'}); t.reset(); }}} className="flex gap-1">
                                <select name="ty" className="flex-1 text-[10px] rounded border p-1 bg-white">{ACTIVITY_TYPES.map(t=><option key={t} value={t}>{t.substring(0,8)}</option>)}</select>
                                <input name="du" type="number" placeholder="Min" className="w-10 text-[10px] rounded border p-1 bg-white" required />
                                <input name="ca" type="number" placeholder="Kcal" className="w-10 text-[10px] rounded border p-1 bg-white" />
                                <button className="bg-orange-500 text-white rounded px-2"><Icons.Plus size={12}/></button>
                            </form>
                        </div>

                        {/* 3. Traitements */}
                        <div className="bg-slate-50 p-2 rounded-lg border border-slate-100">
                            <div className="text-[10px] font-bold text-slate-400 mb-1 uppercase">Traitements</div>
                            <div className="grid grid-cols-2 gap-1.5">
                                {configSupplements.map(supp => (
                                    <label key={supp.id} className={`flex items-center gap-1.5 p-1.5 rounded border text-[10px] cursor-pointer transition-all select-none ${data.supplements?.[supp.id] ? 'bg-indigo-50 border-indigo-200 text-indigo-700 font-semibold' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                        <input type="checkbox" checked={!!data.supplements?.[supp.id]} onChange={() => onUpdate('supplements', !data.supplements?.[supp.id], supp.id)} className="rounded text-indigo-600 focus:ring-0 w-3 h-3" />
                                        <span className="truncate">{supp.name}</span>
                                    </label>
                                ))}
                            </div>
                        </div>

                        {/* 4. Indicateurs & Notes */}
                        <div className="space-y-2">
                            <div className="grid grid-cols-4 gap-1">
                                {configMetrics.map(m => (
                                    <div key={m.id} className="text-center">
                                        <div className="text-[9px] font-bold text-slate-400 uppercase truncate mb-0.5" title={m.label}>{m.label.substring(0,6)}</div>
                                        <select value={data.metrics?.[m.id]||''} onChange={(e) => onUpdate('metrics', e.target.value, m.id)} className={`w-full p-0.5 text-xs text-center rounded border focus:ring-indigo-500 outline-none ${data.metrics?.[m.id] ? (parseInt(data.metrics[m.id])>=7?'bg-emerald-50 border-emerald-200 text-emerald-700 font-bold':'bg-amber-50 border-amber-200 text-amber-700') : 'bg-white border-slate-200'}`}>
                                            <option value="">-</option>{[...Array(11).keys()].map(n=><option key={n} value={n}>{n}</option>)}
                                        </select>
                                    </div>
                                ))}
                            </div>
                            <textarea value={data.notes} onChange={(e) => onUpdate('notes', e.target.value)} placeholder="Notes..." className="w-full h-16 text-xs p-2 rounded border border-slate-200 bg-white focus:ring-1 focus:ring-indigo-500 resize-none" />
                        </div>
                    </div>
                </div>
            );
        };

        // --- Application Principale ---
        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [currentUser, setCurrentUser] = useState('');
            const [activeTab, setActiveTab] = useState('tracker'); 

            // Etats
            const [configSupplements, setConfigSupplements] = useState(() => JSON.parse(safeStorage.getItem('sante_config_supplements_v3') || JSON.stringify(DEFAULT_SUPPLEMENTS)));
            const [configMetrics, setConfigMetrics] = useState(() => JSON.parse(safeStorage.getItem('sante_config_metrics_v3') || JSON.stringify(DEFAULT_METRICS)));
            const [weeksList, setWeeksList] = useState(() => {
                const saved = safeStorage.getItem('sante_weeks_list');
                if (saved) return JSON.parse(saved);
                const current = getWeekDates();
                return [{ id: current.id, label: `Sem. ${current.startStr}`, objective: "" }];
            });
            const [activeWeekId, setActiveWeekId] = useState(() => {
                const savedList = safeStorage.getItem('sante_weeks_list');
                return savedList ? JSON.parse(savedList).slice(-1)[0].id : getWeekDates().id;
            });
            const [allWeeksData, setAllWeeksData] = useState(() => {
                const saved = safeStorage.getItem('sante_all_weeks_data_v3');
                if (saved) return JSON.parse(saved);
                const current = getWeekDates();
                const initialWeek = {};
                DAYS.forEach(day => { initialWeek[day] = JSON.parse(JSON.stringify(INITIAL_DAY_DATA)); });
                return { [current.id]: { days: initialWeek, review: { victories: '', adjustments: '' } } };
            });

            useEffect(() => {
                if (isAuthenticated) {
                    safeStorage.setItem('sante_config_supplements_v3', JSON.stringify(configSupplements));
                    safeStorage.setItem('sante_config_metrics_v3', JSON.stringify(configMetrics));
                    safeStorage.setItem('sante_weeks_list', JSON.stringify(weeksList));
                    safeStorage.setItem('sante_all_weeks_data_v3', JSON.stringify(allWeeksData));
                }
            }, [configSupplements, configMetrics, weeksList, allWeeksData, isAuthenticated]);

            const currentWeekData = allWeeksData[activeWeekId] || { days: {}, review: {} };
            const currentWeekMeta = weeksList.find(w => w.id === activeWeekId) || weeksList[0];
            const currentIndex = weeksList.findIndex(w => w.id === activeWeekId);

            // Generic Update Handler
            const handleDayUpdate = (day, type, value, subId = null) => {
                setAllWeeksData(prev => {
                    const week = prev[activeWeekId] ? { ...prev[activeWeekId] } : { days: {}, review: {} };
                    const dayData = week.days[day] ? { ...week.days[day] } : JSON.parse(JSON.stringify(INITIAL_DAY_DATA));
                    
                    if (type === 'supplements') dayData.supplements = { ...dayData.supplements, [subId]: value };
                    else if (type === 'metrics') dayData.metrics = { ...dayData.metrics, [subId]: value };
                    else if (type === 'sleep') dayData.sleep = { ...dayData.sleep, [subId]: value };
                    else if (type === 'hydration') dayData.hydration = value;
                    else if (type === 'notes') dayData.notes = value;
                    else if (type === 'addActivity') {
                        const newAct = { id: Date.now(), ...value };
                        dayData.activities = [...(dayData.activities || []), newAct];
                    }
                    
                    week.days[day] = dayData;
                    return { ...prev, [activeWeekId]: week };
                });
            };

            const handleDeleteActivity = (day, actId) => {
                setAllWeeksData(prev => {
                    const week = { ...prev[activeWeekId] };
                    const dayData = { ...week.days[day] };
                    dayData.activities = dayData.activities.filter(a => a.id !== actId);
                    week.days[day] = dayData;
                    return { ...prev, [activeWeekId]: week };
                });
            };

            const createNewWeek = () => {
                const lastWeekId = weeksList[weeksList.length - 1].id;
                const lastDate = new Date(lastWeekId);
                lastDate.setDate(lastDate.getDate() + 7); 
                const nextStart = lastDate;
                const nextEnd = new Date(lastDate);
                nextEnd.setDate(nextEnd.getDate() + 6);
                const newWeekId = nextStart.toISOString().split('T')[0];
                const newWeekLabel = `Sem. ${nextStart.toLocaleDateString('fr-FR', {day: 'numeric', month:'numeric'})}`;
                setWeeksList(prev => [...prev, { id: newWeekId, label: newWeekLabel, objective: '' }]);
                const emptyWeekData = {};
                DAYS.forEach(day => { emptyWeekData[day] = JSON.parse(JSON.stringify(INITIAL_DAY_DATA)); });
                setAllWeeksData(prev => ({ ...prev, [newWeekId]: { days: emptyWeekData, review: { victories: '', adjustments: '' } } }));
                setActiveWeekId(newWeekId);
            };

            const copyForAI = () => {
                let prompt = `Analyse mes données santé/sport pour la ${currentWeekMeta.label}.\nObjectif: ${currentWeekMeta.objective}\n\n`;
                DAYS.forEach(day => {
                    const data = currentWeekData.days[day] || INITIAL_DAY_DATA;
                    prompt += `--- ${day.toUpperCase()} ---\n`;
                    prompt += `Sommeil: ${data.sleep?.hours || '?'}h (${data.sleep?.quality || '?'}/5) | Eau: ${data.hydration}\n`;
                    if (data.activities?.length > 0) data.activities.forEach(act => prompt += `Sport: ${act.type} ${act.duration}min\n`);
                    configMetrics.forEach(m => { if(data.metrics?.[m.id]) prompt += `${m.label}: ${data.metrics[m.id]}/10 | `; });
                    if (data.notes) prompt += `\nNotes: ${data.notes}\n`;
                    prompt += `\n`;
                });
                navigator.clipboard.writeText(prompt);
                alert("Données copiées !");
            };

            const handleLogin = (user) => { setCurrentUser(user); setIsAuthenticated(true); };
            const handleLogout = () => { setIsAuthenticated(false); setCurrentUser(''); };

            const addSupplement = (name, dosage, time) => setConfigSupplements([...configSupplements, { id: Date.now().toString(), name, dosage, time }]);
            const removeSupplement = (id) => setConfigSupplements(configSupplements.filter(s => s.id !== id));
            const updateSupplementDosage = (id, newDosage) => setConfigSupplements(prev => prev.map(s => s.id === id ? { ...s, dosage: newDosage } : s));
            const addMetric = (label) => setConfigMetrics([...configMetrics, { id: Date.now().toString(), label }]);
            const removeMetric = (id) => setConfigMetrics(configMetrics.filter(m => m.id !== id));

            if (!isAuthenticated) return <AuthScreen onLogin={handleLogin} />;

            return (
                <div className="min-h-screen bg-slate-100 pb-24 font-sans text-slate-800">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm safe-area-top">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-indigo-600 p-1.5 rounded-lg text-white"><Icons.Activity size={20} /></div>
                                <h1 className="text-lg font-bold text-slate-900 leading-none">Tracker <span className="text-indigo-600">Pro</span></h1>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setActiveTab(activeTab === 'tracker' ? 'settings' : 'tracker')} className="text-slate-500 hover:text-indigo-600 transition-colors">
                                    {activeTab === 'tracker' ? <Icons.Settings size={22} /> : <span className="font-bold text-sm">Retour</span>}
                                </button>
                                <button onClick={copyForAI} className="text-indigo-600"><Icons.ClipboardCopy size={22} /></button>
                            </div>
                        </div>
                        
                        {activeTab === 'tracker' && (
                            <div className="bg-slate-50 px-4 py-2 flex items-center justify-between border-b border-slate-200">
                                <button onClick={() => currentIndex > 0 && setActiveWeekId(weeksList[currentIndex - 1].id)} disabled={currentIndex === 0} className="p-1 text-slate-400 disabled:opacity-20"><Icons.ChevronLeft size={24}/></button>
                                <div className="text-center">
                                    <div className="text-xs uppercase text-slate-400 font-bold tracking-wider">Semaine</div>
                                    <div className="text-sm font-bold text-slate-800">{currentWeekMeta.label}</div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => currentIndex < weeksList.length - 1 && setActiveWeekId(weeksList[currentIndex + 1].id)} disabled={currentIndex === weeksList.length - 1} className="p-1 text-slate-400 disabled:opacity-20"><Icons.ChevronRight size={24}/></button>
                                    <button onClick={createNewWeek} className="text-indigo-600"><Icons.PlusCircle size={24}/></button>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-[1400px] mx-auto p-4">
                        {activeTab === 'settings' && (
                            <div className="max-w-2xl mx-auto space-y-4 animate-card">
                                <Card className="p-4">
                                    <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.BarChart size={18} className="text-indigo-600"/> Indicateurs</h3>
                                    <div className="space-y-2 mb-4">
                                        {configMetrics.map(m => (
                                            <div key={m.id} className="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100 text-sm">
                                                <span>{m.label}</span>
                                                <button onClick={() => removeMetric(m.id)} className="text-red-400"><Icons.Trash2 size={16}/></button>
                                            </div>
                                        ))}
                                    </div>
                                    <form onSubmit={(e) => { e.preventDefault(); const l = e.target.el.value; if(l) { addMetric(l); e.target.reset(); }}} className="flex gap-2">
                                        <input name="el" placeholder="Nouveau (ex: Stress)" className="flex-1 text-sm p-2 border rounded" required />
                                        <button className="bg-slate-800 text-white p-2 rounded"><Icons.Plus size={18}/></button>
                                    </form>
                                </Card>
                                <Card className="p-4">
                                    <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.Settings size={18} className="text-indigo-600"/> Traitements</h3>
                                    <div className="space-y-6">
                                        {['matin', 'midi', 'soir'].map(time => (
                                            <div key={time}>
                                                <h4 className="font-bold text-xs uppercase text-slate-400 mb-2">{time}</h4>
                                                <div className="space-y-2 mb-2">
                                                    {configSupplements.filter(s => s.time === time).map(s => (
                                                        <div key={s.id} className="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100 text-sm">
                                                            <div><span className="font-medium">{s.name}</span> <span className="text-xs text-slate-400">({s.dosage})</span></div>
                                                            <button onClick={() => removeSupplement(s.id)} className="text-red-400"><Icons.Trash2 size={16}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                                <form onSubmit={(e) => { e.preventDefault(); const t = e.target; if(t.n.value) { addSupplement(t.n.value, t.d.value, time); t.reset(); }}} className="flex gap-2">
                                                    <input name="n" placeholder="Nom" className="flex-1 text-sm p-2 border rounded" required />
                                                    <input name="d" placeholder="Dosage" className="w-20 text-sm p-2 border rounded" />
                                                    <button className="bg-slate-800 text-white p-2 rounded"><Icons.Plus size={18}/></button>
                                                </form>
                                            </div>
                                        ))}
                                    </div>
                                </Card>
                                <button onClick={handleLogout} className="w-full py-3 text-red-500 font-bold text-sm bg-red-50 rounded-xl border border-red-100">Se Déconnecter</button>
                            </div>
                        )}

                        {activeTab === 'tracker' && (
                            <div className="space-y-4">
                                <div className="bg-white p-3 rounded-xl border border-indigo-100 shadow-sm max-w-2xl mx-auto">
                                    <label className="text-[10px] text-indigo-500 uppercase font-bold tracking-wider mb-1 block">Objectif Semaine</label>
                                    <input value={currentWeekMeta.objective} onChange={(e) => {
                                        const val = e.target.value;
                                        setWeeksList(prev => prev.map(w => w.id === activeWeekId ? { ...w, objective: val } : w));
                                    }} className="block w-full text-sm font-medium text-slate-700 bg-transparent outline-none" placeholder="Ex: 3 séances, Sommeil..." />
                                </div>

                                {/* GRILLE RESPONSIVE : 1 col mobile, 2 col tablette, 3 col desktop, 4 col large */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                    {DAYS.map((day) => (
                                        <DayCard 
                                            key={day} 
                                            day={day} 
                                            data={currentWeekData.days[day] || INITIAL_DAY_DATA}
                                            configSupplements={configSupplements}
                                            configMetrics={configMetrics}
                                            onUpdate={(type, val, sub) => handleDayUpdate(day, type, val, sub)}
                                            onDeleteActivity={(id) => handleDeleteActivity(day, id)}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
